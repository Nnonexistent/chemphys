{% extends "base.html" %}
{% load i18n ctxhelp static %}

{% block content %}
    <p class="text-center">
        <img src="{% static "img/msu.png" %}" alt="" />
        <div class="h4 text-center" style="margin: -90px 0 60px">{% trans "Lomonosov Moscow State University<br />Institute of Mechanics" %}</div>
    </p>

    {% if user.is_authenticated %}
    <div class="panel panel-default">
        <div class="panel-body row">
            <div class="col-md-4">
                <span class="pull-right">{% ctxhelp _("This is context help. You can invoke it by pressing on this symbol on any page. To&nbsp;close it press the symbol again.") %}</span>
                <p>
                {% if user.has_journal_profile %}
                {% blocktrans with user=user link=user.get_absolute_url %}You are logged in as <a href="{{ link }}">{{ user }}</a>{% endblocktrans %}.
                {% else %}
                {% blocktrans with user=user %}You are logged in as {{ user }}{% endblocktrans %}.
                {% endif %}
                <a class="btn btn-default btn-xs" href="{% url 'logout' %}">{% trans "Logout" %}</a>
                </p>
                <p><a class="btn btn-info" href="{% url 'edit_author' %}"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> {% trans "Edit profile" %}</a></p>
                <p><a class="btn btn-info" href="{% url 'add_article' %}"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> {% trans "Add article" %}</a></p>
            </div>
            <div class="col-md-8">
        {% if user.unpublished_articles %}
                <h5>{% trans "Unpublished articles" %}</h5>
                <table class="table">
                <thead>
                <tr>
                    <th>{% trans "Title" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for article in user.unpublished_articles %}
                <tr>
                <td>
                    {% if article.adding %}
                    <a href="{% url "adding_article" article.id article.status %}">{{ article }}</a>
                    {% else %}
                    {{ article }}
                    {% endif %}
                </td>
                {# TODO: display author-friendly status descriptions. Such as "Pending moderation" instead of "New" #}
                <td>{{ article.get_status_display }}</td>
                <td>{% if article.adding %}<a class="btn btn-primary btn-xs" href="{% url "adding_article" article.id article.status %}">{% trans "Continue filling form" %}</a>{% endif %}</td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
        {% endif %}
        {% if user.pending_reviews %}
                <h5>{% trans "Pending reviews" %}</h5>
                <table class="table">
                <thead>
                <tr>
                    <th>{% trans "Article" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for review in user.pending_reviews %}
                <tr>
                <td><a href="{{ review.get_absolute_url }}">{{ review.article }}</a></td>
                <td>{{ review.get_status_display }}</td>
                <td><a class="btn btn-primary btn-xs" href="{{ review.get_absolute_url }}">{% trans "Proceed to review form" %}</a></td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
        {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="panel panel-default">
        <div class="panel-body">
        {% for article in recent_articles %}
        {% if forloop.first %}<h5>{% trans "Recent articles" %}</h5><table class="table">{% endif %}
        <tr>
            <td>{% if article.image %}<a href="{{ article.get_absolute_url }}"><img src="{{ article.image.url }}" width="100" alt="" /></a>{% endif %}</td>
            <td>
                <a class="text-muted" href="{{ article.issue.get_absolute_url }}">{{ article.issue }}</a><br />
                <a href="{{ article.get_absolute_url }}">{{ article }}</a><br />
                <span class="text-muted">
                {% for aa in article.articleauthor_set.all %}
                    <a href="{{ aa.user.get_absolute_url }}" class="text-muted" title="{{ aa.organization }}">{{ aa.user }}</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
                </span>
            </td>
            <td><a href="{{ article.content.url }}" class="btn btn-primary">View article <br /><small class="text-muted">PDF, {{ article.content.size|filesizeformat }}</small></a></td>
        </tr>
        {% if forloop.last %}</table>{% endif %}
        {% endfor %}
        </div>
    </div>

    {% if user.is_anonymous %}
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-body">
                    <p>{% trans "Чтобы отправить статью войдите в журнал, используя свой e-mail. Вы получите письмо со ссылкой для входа." %}</p>
                    <form role="form" method="post" action="{% url 'mailauth_form' %}">
                    {% csrf_token %}
                    {{ auth_form }}
                    <input class="btn btn-info pull-right" type="submit" value="{% trans "Enter journal" %}" />
                    </form>
                    <br /><br />
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}